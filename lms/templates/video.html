<%page expression_filter="h"/>

<%!
from django.utils.translation import ugettext as _
from openedx.core.djangolib.js_utils import js_escaped_string
%>
% if display_name is not UNDEFINED and display_name is not None:
    <h3 class="hd hd-2">${display_name}</h3>
% endif

<video id="le-player_${id}"></video>

<%block name="jsextra">
<script>
(function(){
  var metadata = '${metadata}'
  //Decode metadata
  metadata = JSON.parse($('<textarea/>').html(metadata).text());

  var YOUTUBE_ID_INDEX = 1;
  var isYoutube = false;

  if(metadata.streams.length > 0) {
    isYoutube = true;
    var ytID = metadata.streams.split(':')[YOUTUBE_ID_INDEX];
  }

  function calcSources(isYoutube) {
    if(isYoutube) {
      return [{ id: ytID }];
    } else {
      return metadata.sources.map(function(item) { return { url: item, title: 'title' } });
    }
  }

  var player = new lePlayer($('#le-player_${id}'), Object.assign({}, {
    entity: isYoutube? 'Youtube': 'Html5',
    sources: calcSources(isYoutube),
    autoplay: metadata.autoplay,
    controls : {
      common : [
        ['play', 'volume', 'timeline', 'rate', 'backward', 'source', 'divider', !isYoutube? 'download' : 'divider', 'fullscreen'],
        []
      ],
      fullscreen : [
        ['play', 'volume', 'timeline', 'rate', 'backward', 'source', 'divider', !isYoutube? 'download' : 'divider', 'fullscreen'],
      ]
    },
    plugins: {
      miniplayer: false,
    }
  }));
})();
</script>
</%block>

% if cdn_eval:
<script>
  //TODO: refactor this js into a separate file.
  function sendPerformanceBeacon(id, expgroup, value, event_name) {
    var data = {event: event_name, id: id, expgroup: expgroup, value: value, page: "html5vid"};
    $.ajax({method: "POST", url: "/performance", data: data});
  }
  var cdnStartTime;
  var salt = Math.floor((1 + Math.random()) * 0x100000).toString(36);
  var id = "${id | n, js_escaped_string}";
  function initializeCDNExperiment() {
    sendPerformanceBeacon(id + "_" + salt, ${cdn_exp_group}, "", "load");
    cdnStartTime = Date.now();
    $.each(['loadstart', 'abort', 'error', 'stalled', 'loadedmetadata',
                    'loadeddata', 'canplay', 'canplaythrough', 'seeked'],
                    function(index, eventName) {
      $("#video_" + id).bind("html5:" + eventName, null, function() {
        timeElapsed = Date.now() - cdnStartTime;
        sendPerformanceBeacon(id + "_" + salt, ${cdn_exp_group}, timeElapsed, eventName);
      });
    });
  }
  $("#video_" + id).bind("initialize", null, initializeCDNExperiment);
  if ($("#video_" + id).hasClass("is-initialized")) {
    initializeCDNExperiment();
  }
</script>
% endif;
